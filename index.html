<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <button class="back-button" id="backButton" style="display: none;">
                <i data-lucide="arrow-left"></i>
            </button>
            <h1 class="header-title" id="headerTitle">–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</h1>
            <button class="theme-toggle" id="themeToggle">
                <i data-lucide="moon" class="theme-icon"></i>
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>

        <div class="screen" id="mainScreen" style="display: none;">
            <div class="tab-content" id="homeTab">
                <div class="purchases-page">
                    <div class="page-header">
                        <h2>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é</h2>
                        <p>–í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–ª—è –æ–±–ª—ñ–∫—É</p>
                    </div>

                    <div class="categories-grid">
                        <div class="category-row">
                            <button class="category-card start-purchase glassmorphism" onclick="startPurchase()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="category-icon"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                <span class="category-label">–ü–æ—á–∞—Ç–∏ –∑–∞–∫—É–ø–∫—É</span>
                            </button>
                        </div>
                        <div class="category-row">
                            <button class="category-card unloading glassmorphism" onclick="startUnloading()">
                                <i data-lucide="truck" class="category-icon"></i>
                                <span class="category-label">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>
                            </button>
                            <button class="category-card delivery glassmorphism" onclick="startDelivery()">
                                <i data-lucide="package" class="category-icon"></i>
                                <span class="category-label">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                            </button>
                        </div>
                        <div class="end-day-section">
                            <button class="end-day-button" onclick="showEndDayModal()">
                                <i data-lucide="sunset"></i>
                                <span>–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="purchasesListTab" style="display: none;">
                <div class="page-header">
                    <h2>–Ü—Å—Ç–æ—Ä—ñ—è –ó–∞–∫—É–ø–æ–∫</h2>
                    <p id="purchasesListSummary">–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</p>
                </div>
                <div class="history-page">
                     <div class="history-controls">
                        <button id="sendPurchasesButton" class="save-button" style="min-width: 150px; flex-grow: 1;">
                            <i data-lucide="upload-cloud" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ</span>
                        </button>
                    </div>
                    <div class="cart-items" id="purchasesListItems"></div>
                    <div class="cart-empty" id="purchasesListEmpty">
                        <div class="empty-icon">üõí</div>
                        <p>–¢—É—Ç –±—É–¥–µ —ñ—Å—Ç–æ—Ä—ñ—è –≤–∞—à–∏—Ö –∑–∞–∫—É–ø–æ–∫</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="unloadingListTab" style="display: none;">
                <div class="page-header">
                    <h2>–Ü—Å—Ç–æ—Ä—ñ—è –ü–µ—Ä–µ–º—ñ—â–µ–Ω—å</h2>
                    <p id="unloadingListSummary">–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</p>
                </div>
                <div class="history-page">
                     <div class="history-controls">
                        <button id="sendUnloadingsButton" class="save-button" style="min-width: 150px; flex-grow: 1;">
                            <i data-lucide="upload-cloud" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ</span>
                        </button>
                    </div>
                    <div class="cart-items" id="unloadingListItems"></div>
                    <div class="cart-empty" id="unloadingListEmpty">
                        <div class="empty-icon">üöö</div>
                        <p>–¢—É—Ç –±—É–¥–µ —ñ—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—å —Ç–∞ –¥–æ—Å—Ç–∞–≤–æ–∫</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reportsTab" style="display: none;">
                 <div class="page-header">
                    <h2>–ó–≤—ñ—Ç–∏</h2>
                    <p>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤–∞—à–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π</p>
                </div>
                <div class="reports-page">
                    <div class="stats-grid" id="statsGrid"></div>
                    <div class="chart-container">
                        <h3>–í–∏—Ç—Ä–∞—Ç–∏ –∑–∞ —Ç–∏–ø–æ–º</h3>
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="purchaseFormScreen" style="display: none;">
            <div class="purchase-form-page">
                 <div class="page-header">
                    <h2 id="formTitle">–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è</h2>
                    <p id="formSubtitle">–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ —Ç–æ–≤–∞—Ä</p>
                </div>
                <div class="form-container glassmorphism">
                    <form class="purchase-form" id="purchaseForm" novalidate>
                        <div class="form-group">
                            <label for="productName">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="productName" list="productSuggestions" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–º—ñ–¥–æ—Ä–∏ —á–µ—Ä–≤–æ–Ω—ñ" required>
                            <datalist id="productSuggestions"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                            <input type="number" id="quantity" step="0.1" min="0" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label for="unit">–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
                            <select id="unit" required></select>
                        </div>
                        <div class="form-group" id="priceGroup">
                            <label for="pricePerUnit">–¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é, ‚Ç¥</label>
                            <input type="number" id="pricePerUnit" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="location" id="locationLabel">–õ–æ–∫–∞—Ü—ñ—è</label>
                            <select id="location" required></select>
                        </div>
                        <div class="form-group" id="customLocationGroup" style="display: none;">
                            <label for="customLocation">–í–∫–∞–∂—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</label>
                            <input type="text" id="customLocation" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó">
                        </div>
                        <div class="form-group">
                            <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä—É</label>
                            <div class="photo-uploader">
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                <button type="button" class="photo-button" onclick="document.getElementById('photoInput').click()">
                                    <i data-lucide="camera"></i>
                                    <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                                </button>
                                <div class="photo-preview" id="photoPreview" style="display: none;">
                                    <img id="previewImage" alt="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥">
                                    <button type="button" class="remove-photo" onclick="removePhoto()">
                                        <i data-lucide="x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="total-display" id="totalGroup">
                            <span id="totalAmount">0.00 ‚Ç¥</span>
                        </div>
                        <button type="submit" class="save-button" id="saveButton">
                            <i data-lucide="save" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span id="saveButtonText">–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-navigation" id="bottomNavigation">
        <button class="nav-button active" data-tab="home" onclick="switchTab('home')">
            <i data-lucide="home"></i>
            <span>–ì–æ–ª–æ–≤–Ω–∞</span>
        </button>
        <button class="nav-button" data-tab="purchasesList" onclick="switchTab('purchasesList')">
            <i data-lucide="shopping-cart"></i>
            <span>–ó–∞–∫—É–ø–∫–∞</span>
        </button>
        <button class="nav-button" data-tab="unloadingList" onclick="switchTab('unloadingList')">
            <i data-lucide="truck"></i>
            <span>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>
        </button>
        <button class="nav-button" data-tab="reports" onclick="switchTab('reports')">
            <i data-lucide="pie-chart"></i>
            <span>–ó–≤—ñ—Ç–∏</span>
        </button>
    </nav>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="endDayModal">
        <div class="modal-content glassmorphism">
            <h3>–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å?</h3>
            <p>–Ü—Å—Ç–æ—Ä—ñ—é –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å –±—É–¥–µ –æ—á–∏—â–µ–Ω–æ. –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?</p>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelEndDay">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn-destructive" id="confirmEndDay">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–û–î–î–ï–†–ñ–ö–û–ô –û–¢–ü–†–ê–í–ö–ò –§–û–¢–û
        
        class AppState {
            constructor() {
                this.screen = 'main';
                this.tab = 'home';
                this.isUnloading = false;
                this.isDelivery = false;
                this.editingItemId = null;
            }
            setScreen(screen, options = {}) {
                this.screen = screen;
                if (options.isUnloading !== undefined) this.isUnloading = options.isUnloading;
                if (options.isDelivery !== undefined) this.isDelivery = options.isDelivery;
                if (options.editingItemId !== undefined) this.editingItemId = options.editingItemId;
                else if (screen === 'main') this.editingItemId = null;
                this.updateUI();
            }
            setTab(tab) {
                this.tab = tab;
                this.updateUI();
            }
            updateUI() {
                document.getElementById('mainScreen').style.display = this.screen === 'main' ? 'block' : 'none';
                document.getElementById('purchaseFormScreen').style.display = this.screen === 'purchase-form' ? 'block' : 'none';
                
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                const activeTab = document.getElementById(`${this.tab}Tab`);
                if(activeTab) activeTab.style.display = 'block';

                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === this.tab);
                });
                this.updateHeader();
                document.getElementById('bottomNavigation').style.display = this.screen === 'main' ? 'flex' : 'none';
            }
            updateHeader() {
                const backButton = document.getElementById('backButton');
                const headerTitle = document.getElementById('headerTitle');
                if (this.screen === 'purchase-form') {
                    backButton.style.display = 'flex';
                    if (this.editingItemId) {
                         headerTitle.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å';
                    } else {
                        headerTitle.textContent = this.isUnloading || this.isDelivery ? '–ù–æ–≤–µ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' : '–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è';
                    }
                } else {
                    backButton.style.display = 'none';
                    headerTitle.textContent = '–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å';
                }
            }
        }
        const appState = new AppState();
        
        const getSecureWebhookUrl = () => {
            const productionUrl = '/api/delivery';
            const localUrl = 'http://localhost:3000/api/delivery';
            let defaultUrl = productionUrl;
            if (typeof window !== 'undefined') {
                const hostname = window.location?.hostname ?? '';
                const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
                if (isLocalhost) defaultUrl = localUrl;
            }
            const overrideUrl = (typeof window !== 'undefined' && window.__SECURE_WEBHOOK_URL__) || '';
            if (overrideUrl && typeof overrideUrl === 'string') {
                try {
                    const parsed = new URL(overrideUrl);
                    if (parsed.protocol === 'https:') {
                        console.log('üîó Webhook URL:', overrideUrl);
                        return overrideUrl;
                    }
                } catch (error) {}
            }
            console.log('üîó Webhook URL:', defaultUrl);
            return defaultUrl;
        };

        const appConfig = {
            N8N_WEBHOOK_URL: getSecureWebhookUrl(),
            units: [
                { value: 'kg', label: '–∫–≥' }, { value: 'piece', label: '—à—Ç' },
                { value: 'pack', label: '—É–ø–∞–∫–æ–≤–∫–∞' }, { value: 'box', label: '—è—â–∏–∫' },
                { value: 'bunch', label: '–ø—É—á–æ–∫' }, { value: 'other', label: '—ñ–Ω—à–µ' }
            ],
            marketLocations: ['–ö–∞–ª–∏–Ω—ñ–≤—Å—å–∫–∏–π —Ä–∏–Ω–æ–∫', '–ó–µ–ª–µ–Ω–∏–π —Ä–∏–Ω–æ–∫', '–ú–µ—Ç—Ä–æ', '–Ü–Ω—à–µ'],
            unloadingLocations: ['–ì–µ—Ä–æ—ó–≤ –ú–∞–π–¥–∞–Ω—É', '–ï–Ω—Ç—É–∑—ñ–∞—Å—Ç—ñ–≤', '–ë—É–ª—å–≤–∞—Ä', '–ì—Ä–∞–≤—ñ—Ç–æ–Ω', '–°–∞–¥–æ–≤–∞', '–§–ª–æ—Ä—ñ–¥–∞', '–ï–Ω—Ç—É–∑—ñ–∞—Å—Ç—ñ–≤ 2 –ø–æ–≤–µ—Ä—Ö', '–ü—ñ—Ü–µ—Ä—ñ—è', '–†—É—Å—å–∫–∞', '–Ü–Ω—à–µ'],
            products: ['–ö–∞—Ä—Ç–æ–ø–ª—è', '–¶–∏–±—É–ª—è', '–ö–∞–ø—É—Å—Ç–∞', '–ú–æ—Ä–∫–≤–∞', '–ë—É—Ä—è–∫', '–ì—Ä–∏–±–∏', '–ü–æ–º—ñ–¥–æ—Ä–∏', '–ë–∞–Ω–∞–Ω', '–ß–∞—Å–Ω–∏–∫', '–ü–µ—Ä–µ—Ü—å', '–ö–∞–±–∞—á–∫–∏', '–ë–∞–∫–ª–∞–∂–∞–Ω', '–õ–∏–º–æ–Ω']
        };

        class StorageManager {
            static get(key, defaultValue = []) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) { return defaultValue; }
            }
            static set(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
            static getHistoryItems() { return this.get('purchase_history', []); }
            static setHistoryItems(items) { this.set('purchase_history', items); }
            static addToHistory(item) {
                const items = this.getHistoryItems();
                items.unshift(item);
                this.setHistoryItems(items);
            }
            static updateHistoryItem(id, updatedItem) {
                let items = this.getHistoryItems();
                const itemIndex = items.findIndex(i => i.id === id);
                if (itemIndex > -1) {
                    items[itemIndex] = { ...items[itemIndex], ...updatedItem };
                    this.setHistoryItems(items);
                }
            }
            static deleteHistoryItem(id) {
                let items = this.getHistoryItems();
                items = items.filter(i => i.id !== id);
                this.setHistoryItems(items);
            }
            static clearHistory() { localStorage.removeItem('purchase_history'); }
        }

        class ToastManager {
            static show(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animationName = 'toast-out';
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }
        }

        class ThemeManager {
            static init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme);
                document.getElementById('themeToggle').addEventListener('click', () => {
                    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                });
            }
            static setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                const themeIcon = document.querySelector('.theme-icon');
                if(themeIcon) {
                    themeIcon.setAttribute('data-lucide', theme === 'light' ? 'moon' : 'sun');
                    lucide.createIcons();
                }
            }
        }
        
        let selectedPhotoBase64 = null;
        let typeChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            ThemeManager.init();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                appState.updateUI();
            }, 500);

            setupEventListeners();
            populateUnitSelect();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed:', err));
            }
        });

        function setupEventListeners() {
            document.getElementById('backButton').addEventListener('click', () => appState.setScreen('main'));
            document.getElementById('purchaseForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('photoInput').addEventListener('change', handlePhotoSelect);
            document.getElementById('quantity').addEventListener('input', updateTotalAmount);
            document.getElementById('pricePerUnit').addEventListener('input', updateTotalAmount);
            document.getElementById('location').addEventListener('change', handleLocationChange);
            
            document.getElementById('sendPurchasesButton').addEventListener('click', () => sendAllToServer('purchasesList'));
            document.getElementById('sendUnloadingsButton').addEventListener('click', () => sendAllToServer('unloadingList'));

            document.getElementById('cancelEndDay').addEventListener('click', hideEndDayModal);
            document.getElementById('confirmEndDay').addEventListener('click', endWorkDay);
        }

        function switchTab(tab) {
            appState.setTab(tab);
            if (tab === 'purchasesList') updateDisplay('purchasesList');
            if (tab === 'unloadingList') updateDisplay('unloadingList');
            if (tab === 'reports') renderReports();
        }
        
        function startPurchase() {
            appState.setScreen('purchase-form', { isUnloading: false, isDelivery: false });
            setupPurchaseForm();
        }
        function startUnloading() {
            appState.setScreen('purchase-form', { isUnloading: true, isDelivery: false });
            setupPurchaseForm();
        }
        function startDelivery() {
            appState.setScreen('purchase-form', { isUnloading: false, isDelivery: true });
            setupPurchaseForm();
        }
        
        function startEdit(itemId) {
            const items = StorageManager.getHistoryItems();
            const item = items.find(i => i.id === itemId);
            if(!item) return;

            const isUnloading = item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            const isDelivery = item.type === '–î–æ—Å—Ç–∞–≤–∫–∞';
            
            appState.setScreen('purchase-form', { isUnloading, isDelivery, editingItemId: itemId });
            setupPurchaseForm();

            document.getElementById('productName').value = item.productName;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('unit').value = item.unit;
            document.getElementById('pricePerUnit').value = item.pricePerUnit;

            const locationSelect = document.getElementById('location');
            const locationExists = Array.from(locationSelect.options).some(opt => opt.value === item.location);
            if(locationExists) {
                locationSelect.value = item.location;
                 handleLocationChange();
            } else {
                 locationSelect.value = '–Ü–Ω—à–µ';
                 handleLocationChange();
                 document.getElementById('customLocation').value = item.location;
            }
            
            if (item.photoBase64) {
                selectedPhotoBase64 = item.photoBase64;
                document.getElementById('previewImage').src = item.photoBase64;
                document.getElementById('photoPreview').style.display = 'block';
            }
            
            updateTotalAmount();
        }

        function setupPurchaseForm() {
            document.getElementById('purchaseForm').reset();
            removePhoto();
            populateDatalist();
            
            const priceGroup = document.getElementById('priceGroup');
            const totalGroup = document.getElementById('totalGroup');
            const locationLabel = document.getElementById('locationLabel');
            const saveButtonText = document.getElementById('saveButtonText');
            const formTitle = document.getElementById('formTitle');
            const formSubtitle = document.getElementById('formSubtitle');
            
            let locations;
            const isEditing = !!appState.editingItemId;
            let currentType = '';
            if (isEditing) {
                const item = StorageManager.getHistoryItems().find(i => i.id === appState.editingItemId);
                if(item) currentType = item.type;
            }

            const isUnloadingOrDelivery = (!isEditing && (appState.isUnloading || appState.isDelivery)) || (isEditing && (currentType === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' || currentType === '–î–æ—Å—Ç–∞–≤–∫–∞'));

            if (isUnloadingOrDelivery) {
                priceGroup.style.display = 'none';
                totalGroup.style.display = 'none';
                locationLabel.textContent = '–ú–∞–≥–∞–∑–∏–Ω (–≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–¥–æ—Å—Ç–∞–≤–∫–∞)';
                locations = appConfig.unloadingLocations;
            } else {
                priceGroup.style.display = 'block';
                totalGroup.style.display = 'block';
                locationLabel.textContent = '–õ–æ–∫–∞—Ü—ñ—è –∑–∞–∫—É–ø–∫–∏';
                locations = appConfig.marketLocations;
            }
            
            if (isEditing) {
                formTitle.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å';
                formSubtitle.textContent = '–ó–º—ñ–Ω—ñ—Ç—å –¥–∞–Ω—ñ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å';
                saveButtonText.textContent = '–û–Ω–æ–≤–∏—Ç–∏ –∑–∞–ø–∏—Å';
            } else if (isUnloadingOrDelivery) {
                formTitle.textContent = '–ù–æ–≤–µ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
                formSubtitle.textContent = '–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è';
                saveButtonText.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ';
            } else {
                formTitle.textContent = '–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è';
                formSubtitle.textContent = '–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ —Ç–æ–≤–∞—Ä';
                saveButtonText.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ';
            }

            setupLocationOptions(locations);
            updateTotalAmount();
            lucide.createIcons();
        }
        
        function populateDatalist() {
            const datalist = document.getElementById('productSuggestions');
            datalist.innerHTML = '';
            appConfig.products.forEach(p => datalist.innerHTML += `<option value="${p}">`);
        }
        
        function populateUnitSelect() {
            const select = document.getElementById('unit');
            select.innerHTML = '';
            appConfig.units.forEach(u => select.innerHTML += `<option value="${u.value}">${u.label}</option>`);
        }

        function setupLocationOptions(locations) {
            const select = document.getElementById('location');
            select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
            locations.forEach(loc => select.innerHTML += `<option value="${loc}">${loc}</option>`);
        }

        function handleLocationChange() {
            const group = document.getElementById('customLocationGroup');
            const customInput = document.getElementById('customLocation');
            const isCustom = document.getElementById('location').value === '–Ü–Ω—à–µ';
            group.style.display = isCustom ? 'block' : 'none';
            customInput.disabled = !isCustom;
            customInput.required = isCustom;
            if (!isCustom) customInput.value = '';
        }

        function updateTotalAmount() {
            if(appState.isUnloading || appState.isDelivery) return;
            const qty = parseFloat(document.getElementById('quantity').value) || 0;
            const price = parseFloat(document.getElementById('pricePerUnit').value) || 0;
            document.getElementById('totalAmount').textContent = (qty * price).toFixed(2) + ' ‚Ç¥';
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedPhotoBase64 = e.target.result;
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            selectedPhotoBase64 = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoInput').value = '';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const isEditing = !!appState.editingItemId;
            let type = '–ó–∞–∫—É–ø–∫–∞';
            if (!isEditing) {
                if (appState.isUnloading) type = '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
                if (appState.isDelivery) type = '–î–æ—Å—Ç–∞–≤–∫–∞';
            } else {
                 const item = StorageManager.getHistoryItems().find(i => i.id === appState.editingItemId);
                 if (item) type = item.type;
            }

            const productName = document.getElementById('productName').value.trim();
            const quantity = parseFloat(document.getElementById('quantity').value);
            let location = document.getElementById('location').value;
            if (location === '–Ü–Ω—à–µ') {
                location = document.getElementById('customLocation').value.trim();
            }

            const itemData = {
                id: isEditing ? appState.editingItemId : crypto.randomUUID(),
                productName,
                quantity,
                unit: document.getElementById('unit').value,
                pricePerUnit: (type === '–ó–∞–∫—É–ø–∫–∞') ? parseFloat(document.getElementById('pricePerUnit').value) || 0 : 0,
                totalAmount: (type === '–ó–∞–∫—É–ø–∫–∞') ? (quantity * (parseFloat(document.getElementById('pricePerUnit').value) || 0)) : 0,
                location,
                timestamp: new Date().toISOString(),
                type,
                photoBase64: selectedPhotoBase64,
            };

            if (isEditing) {
                StorageManager.updateHistoryItem(appState.editingItemId, itemData);
                ToastManager.show(`'${productName}' –æ–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ`, 'success');
            } else {
                StorageManager.addToHistory(itemData);
                ToastManager.show(`'${productName}' –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ`, 'success');
            }

            appState.setScreen('main');

            if (itemData.type === '–ó–∞–∫—É–ø–∫–∞') {
                appState.setTab('purchasesList');
            } else {
                appState.setTab('unloadingList');
            }
            updateDisplay(appState.tab);
        }
        
        // –ì–ò–ë–†–ò–î–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê: FormData –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–æ—Ç–æ, JSON –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
        async function sendAllToServer(listType) {
            const buttonId = listType === 'purchasesList' ? 'sendPurchasesButton' : 'sendUnloadingsButton';
            const button = document.getElementById(buttonId);
            const buttonIcon = button.querySelector('.button-icon');
            const buttonSpinner = button.querySelector('.button-spinner');

            button.disabled = true;
            buttonIcon.style.display = 'none';
            buttonSpinner.style.display = 'inline-block';

            const allItems = StorageManager.getHistoryItems();
            const itemsToSend = allItems.filter(item => {
                if (listType === 'purchasesList') return item.type === '–ó–∞–∫—É–ø–∫–∞';
                return item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' || item.type === '–î–æ—Å—Ç–∞–≤–∫–∞';
            });

            if (itemsToSend.length === 0) {
                ToastManager.show('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏', 'info');
                button.disabled = false;
                buttonIcon.style.display = 'inline-block';
                buttonSpinner.style.display = 'none';
                return;
            }

            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${itemsToSend.length} –∑–∞–ø–∏—Å–µ–π...`);

            const promises = itemsToSend.map(async (item, index) => {
                try {
                    console.log(`üì¶ [${index + 1}/${itemsToSend.length}] –û—Ç–ø—Ä–∞–≤–∫–∞: ${item.productName}`);
                    
                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const eventDate = new Date(item.timestamp);
                    const isoDate = eventDate.toISOString();
                    const [datePart, timePartWithMs] = isoDate.split('T');
                    const timePart = timePartWithMs ? timePartWithMs.split('.')[0] : '';
                    
                    const itemData = {
                        id: item.id,
                        type: item.type,
                        timestamp: item.timestamp,
                        date: datePart,
                        time: timePart,
                        productName: item.productName,
                        quantity: item.quantity,
                        unit: item.unit,
                        pricePerUnit: item.pricePerUnit,
                        totalAmount: item.totalAmount,
                        location: item.location
                    };
                    
                    let response;
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    
                    try {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ n8n —Å FormData
                        if (item.photoBase64) {
                            console.log('üì∏ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ FormData...');
                            
                            const formData = new FormData();
                            formData.append('data', JSON.stringify(itemData));
                            
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ Blob
                            const base64Data = item.photoBase64.split(',')[1] || item.photoBase64;
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/jpeg' });
                            
                            formData.append('file', blob, `photo_${item.id}.jpg`);
                            
                            console.log(`üì∏ –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: ${(blob.size / 1024).toFixed(2)} KB`);
                            
                            // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ n8n (–æ–±—Ö–æ–¥–∏–º –ø—Ä–æ–∫—Å–∏)
                            const directUrl = 'https://n8n.dmytrotovstytskyi.online/webhook/delivery';
                            
                            response = await fetch(directUrl, {
                                method: 'POST',
                                body: formData,
                                signal: controller.signal,
                                mode: 'cors'
                            });
                            
                        } else {
                            // –ë–µ–∑ —Ñ–æ—Ç–æ - —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ —Å JSON
                            console.log('üìÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ JSON...');
                            
                            const payload = {
                                version: 1,
                                submission: itemData,
                                context: { date: datePart, time: timePart },
                                flat: {
                                    timestamp: String(itemData.timestamp),
                                    date: String(datePart),
                                    time: String(timePart),
                                    type: String(itemData.type),
                                    productName: String(itemData.productName),
                                    quantity: String(itemData.quantity),
                                    unit: String(itemData.unit),
                                    pricePerUnit: String(itemData.pricePerUnit),
                                    totalAmount: String(itemData.totalAmount),
                                    location: String(itemData.location)
                                }
                            };
                            
                            response = await fetch(appConfig.N8N_WEBHOOK_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload),
                                signal: controller.signal
                            });
                        }
                        
                        clearTimeout(timeoutId);
                        
                        const responseText = await response.text();
                        
                        if (!response.ok) {
                            console.error(`‚ùå HTTP ${response.status}:`, responseText);
                            throw new Error(`HTTP ${response.status}: ${responseText.substring(0, 100)}`);
                        }
                        
                        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${item.productName}`);
                        return item.id;
                        
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                    
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ [${item.productName}]:`, error.message);
                    return null;
                }
            });

            const results = await Promise.all(promises);
            const successfulIds = new Set(results.filter(id => id !== null));
            const failedCount = itemsToSend.length - successfulIds.size;

            console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${successfulIds.size} —É—Å–ø–µ—à–Ω–æ, ${failedCount} –æ—à–∏–±–æ–∫`);

            // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
            const remainingItems = allItems.filter(item => !successfulIds.has(item.id));
            StorageManager.setHistoryItems(remainingItems);
            
            updateDisplay(listType);

            if (failedCount > 0) {
                ToastManager.show(`–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${successfulIds.size}. –ü–æ–º–∏–ª–∫–∞: ${failedCount}`, 'error');
            } else {
                ToastManager.show(`–í—Å—ñ ${successfulIds.size} –∑–∞–ø–∏—Å–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ`, 'success');
            }
            
            button.disabled = false;
            buttonIcon.style.display = 'inline-block';
            buttonSpinner.style.display = 'none';
        }

        function updateDisplay(listType) {
            const allItems = StorageManager.getHistoryItems();
            let itemsToShow;
            let container, summary, empty;

            if (listType === 'purchasesList') {
                itemsToShow = allItems.filter(item => item.type === '–ó–∞–∫—É–ø–∫–∞');
                container = document.getElementById('purchasesListItems');
                summary = document.getElementById('purchasesListSummary');
                empty = document.getElementById('purchasesListEmpty');
            } else {
                itemsToShow = allItems.filter(item => item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' || item.type === '–î–æ—Å—Ç–∞–≤–∫–∞');
                container = document.getElementById('unloadingListItems');
                summary = document.getElementById('unloadingListSummary');
                empty = document.getElementById('unloadingListEmpty');
            }

            container.innerHTML = '';

            if(itemsToShow.length > 0) {
                empty.style.display = 'none';
                
                itemsToShow.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item glassmorphism';
                    const unitLabel = appConfig.units.find(u => u.value === item.unit)?.label || item.unit;
                    const photoPreviewHTML = item.photoBase64 
                        ? `<img src="${item.photoBase64}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; margin-right: 12px;">` 
                        : '<div style="width: 40px; height: 40px; margin-right: 12px;"></div>';

                    itemEl.innerHTML = `
                        <div class="cart-item-header">
                            <div style="display: flex; align-items: center; flex-grow: 1;">
                                ${photoPreviewHTML}
                                <div>
                                    <div class="cart-item-name">${item.productName}</div>
                                    <div class="cart-item-category">${item.type}</div>
                                </div>
                            </div>
                            <div class="cart-item-actions">
                                <button onclick="startEdit('${item.id}')"><i data-lucide="edit-2"></i></button>
                                <button class="delete" onclick="deleteItem('${item.id}')"><i data-lucide="trash-2"></i></button>
                            </div>
                        </div>
                        <div class="cart-item-details">
                            <div><span class="cart-item-detail-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</span> ${item.quantity} ${unitLabel}</div>
                            <div><span class="cart-item-detail-label">–õ–æ–∫–∞—Ü—ñ—è:</span> ${item.location}</div>
                            <div class="cart-item-total"><span class="cart-item-detail-label">–°—É–º–∞:</span> ${item.totalAmount.toFixed(2)} ‚Ç¥</div>
                        </div>
                    `;
                    container.appendChild(itemEl);
                });
                summary.textContent = `${itemsToShow.length} –∑–∞–ø–∏—Å(—ñ–≤)`;
            } else {
                empty.style.display = 'block';
                summary.textContent = '–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤';
            }
            lucide.createIcons();
        }

        function deleteItem(id) {
            const itemToDelete = StorageManager.getHistoryItems().find(item => item.id === id);
            StorageManager.deleteHistoryItem(id);
            if (itemToDelete.type === '–ó–∞–∫—É–ø–∫–∞') {
                updateDisplay('purchasesList');
            } else {
                updateDisplay('unloadingList');
            }
            ToastManager.show('–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
        }

        function renderReports() {
            const items = StorageManager.getHistoryItems();
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            const totalSpent = items.reduce((sum, item) => sum + item.totalAmount, 0);
            const totalItems = items.length;
            
            const stats = [
                { label: '–í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—á–µ–Ω–æ', value: `${totalSpent.toFixed(2)} ‚Ç¥` },
                { label: '–í—Å—å–æ–≥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π', value: totalItems },
            ];

            stats.forEach(stat => {
                statsGrid.innerHTML += `
                    <div class="stat-card glassmorphism">
                        <div class="stat-card-value">${stat.value}</div>
                        <div class="stat-card-label">${stat.label}</div>
                    </div>
                `;
            });

            const ctx = document.getElementById('typeChart').getContext('2d');
            const dataByType = items.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + item.totalAmount;
                return acc;
            }, {});

            if(typeChartInstance) {
                typeChartInstance.destroy();
            }

            typeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataByType),
                    datasets: [{
                        label: '–í–∏—Ç—Ä–∞—Ç–∏ –∑–∞ —Ç–∏–ø–æ–º',
                        data: Object.values(dataByType),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b'],
                        borderColor: 'var(--card)',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'var(--foreground)' } },
                    }
                }
            });
        }

        function showEndDayModal() {
            document.getElementById('endDayModal').classList.add('visible');
        }
        function hideEndDayModal() {
            document.getElementById('endDayModal').classList.remove('visible');
        }
        function endWorkDay() {
            StorageManager.clearHistory();
            updateDisplay('purchasesList');
            updateDisplay('unloadingList');
            hideEndDayModal();
            ToastManager.show('–†–æ–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ.', 'success');
        }

        window.switchTab = switchTab;
        window.startPurchase = startPurchase;
        window.startUnloading = startUnloading;
        window.startDelivery = startDelivery;
        window.startEdit = startEdit;
        window.deleteItem = deleteItem;
        window.showEndDayModal = showEndDayModal;
        window.removePhoto = removePhoto;
    </script>
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-actions button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-secondary {
            background: var(--muted);
            color: var(--muted-foreground);
        }
        .btn-destructive {
            background: var(--destructive);
            color: var(--destructive-foreground);
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
        }
        .stat-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-card-label {
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
        }
        .reports-page {
            padding: 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</body>
</html>
