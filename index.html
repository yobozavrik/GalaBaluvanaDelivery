<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <button class="back-button" id="backButton" style="display: none;" type="button">
                <i data-lucide="arrow-left"></i>
            </button>
            <h1 class="header-title" id="headerTitle">–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</h1>
            <div class="header-actions">
                <button class="mode-toggle" id="modeToggle" type="button" aria-pressed="false">
                    <span class="mode-indicator"></span>
                    <span id="modeToggleLabel">–†–æ–±–æ—á–∏–π —Ä–µ–∂–∏–º</span>
                </button>
                <button class="theme-toggle" id="themeToggle" type="button">
                    <i data-lucide="moon" class="theme-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>

        <div class="screen" id="mainScreen" style="display: none;">
            <div class="tab-content" id="homeTab">
                <div class="purchases-page">
                    <div class="page-header">
                        <h2>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é</h2>
                        <p>–í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–ª—è –æ–±–ª—ñ–∫—É</p>
                    </div>

                    <div class="categories-grid">
                        <div class="category-row">
                            <button class="category-card start-purchase glassmorphism" onclick="startPurchase()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="category-icon"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                <span class="category-label">–ü–æ—á–∞—Ç–∏ –∑–∞–∫—É–ø–∫—É</span>
                            </button>
                        </div>
                        <div class="category-row">
                            <button class="category-card unloading glassmorphism" onclick="startUnloading()">
                                <i data-lucide="truck" class="category-icon"></i>
                                <span class="category-label">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>
                            </button>
                            <button class="category-card delivery glassmorphism" onclick="startDelivery()">
                                <i data-lucide="package" class="category-icon"></i>
                                <span class="category-label">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                            </button>
                        </div>
                        <div class="end-day-section">
                            <button class="end-day-button" onclick="showEndDayModal()">
                                <i data-lucide="sunset"></i>
                                <span>–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="purchasesListTab" style="display: none;">
                <div class="page-header">
                    <h2>–Ü—Å—Ç–æ—Ä—ñ—è –ó–∞–∫—É–ø–æ–∫</h2>
                    <p id="purchasesListSummary">–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</p>
                </div>
                <div class="history-page">
                     <div class="history-controls">
                        <button id="sendPurchasesButton" class="save-button" style="min-width: 150px; flex-grow: 1;">
                            <i data-lucide="upload-cloud" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ</span>
                        </button>
                    </div>
                    <div class="cart-items" id="purchasesListItems"></div>
                    <div class="cart-empty" id="purchasesListEmpty">
                        <div class="empty-icon">üõí</div>
                        <p>–¢—É—Ç –±—É–¥–µ —ñ—Å—Ç–æ—Ä—ñ—è –≤–∞—à–∏—Ö –∑–∞–∫—É–ø–æ–∫</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="unloadingListTab" style="display: none;">
                <div class="page-header">
                    <h2>–Ü—Å—Ç–æ—Ä—ñ—è –ü–µ—Ä–µ–º—ñ—â–µ–Ω—å</h2>
                    <p id="unloadingListSummary">–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</p>
                </div>
                <div class="history-page">
                     <div class="history-controls">
                        <button id="sendUnloadingsButton" class="save-button" style="min-width: 150px; flex-grow: 1;">
                            <i data-lucide="upload-cloud" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ</span>
                        </button>
                    </div>
                    <div class="cart-items" id="unloadingListItems"></div>
                    <div class="cart-empty" id="unloadingListEmpty">
                        <div class="empty-icon">üöö</div>
                        <p>–¢—É—Ç –±—É–¥–µ —ñ—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—å —Ç–∞ –¥–æ—Å—Ç–∞–≤–æ–∫</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reportsTab" style="display: none;">
                 <div class="page-header">
                    <h2>–ó–≤—ñ—Ç–∏</h2>
                    <p>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤–∞—à–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π</p>
                </div>
                <div class="reports-page">
                    <div class="stats-grid" id="statsGrid"></div>
                    <div class="chart-container">
                        <h3>–í–∏—Ç—Ä–∞—Ç–∏ –∑–∞ —Ç–∏–ø–æ–º</h3>
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="purchaseFormScreen" style="display: none;">
            <div class="purchase-form-page">
                 <div class="page-header">
                    <h2 id="formTitle">–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è</h2>
                    <p id="formSubtitle">–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ —Ç–æ–≤–∞—Ä</p>
                </div>
                <div class="form-container glassmorphism">
                    <form class="purchase-form" id="purchaseForm" novalidate>
                        <div class="form-group">
                            <label for="productName">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="productName" list="productSuggestions" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–º—ñ–¥–æ—Ä–∏ —á–µ—Ä–≤–æ–Ω—ñ" required>
                            <datalist id="productSuggestions"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                            <input type="number" id="quantity" step="0.1" min="0" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label for="unit">–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
                            <select id="unit" required></select>
                        </div>
                        <div class="form-group" id="priceGroup">
                            <label for="pricePerUnit">–¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é, ‚Ç¥</label>
                            <input type="number" id="pricePerUnit" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="location" id="locationLabel">–õ–æ–∫–∞—Ü—ñ—è</label>
                            <select id="location" required></select>
                        </div>
                        <div class="form-group" id="customLocationGroup" style="display: none;">
                            <label for="customLocation">–í–∫–∞–∂—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</label>
                            <input type="text" id="customLocation" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó">
                        </div>
                        <div class="form-group">
                            <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä—É</label>
                            <div class="photo-uploader">
                                <input type="file" id="photoInput" accept="image/*,.heic,.heif" style="display: none;">
                                <button type="button" class="photo-button" onclick="document.getElementById('photoInput').click()">
                                    <i data-lucide="camera"></i>
                                    <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                                </button>
                                <div class="photo-preview" id="photoPreview" style="display: none;">
                                    <img id="previewImage" alt="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥">
                                    <div id="photoPreviewFallback" class="photo-preview-fallback" style="display: none;">
                                        –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è —Ü—å–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É, –∞–ª–µ —Ñ–∞–π–ª –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.
                                    </div>
                                    <button type="button" class="remove-photo" onclick="removePhoto()">
                                        <i data-lucide="x"></i>
                                    </button>
                                </div>
                                <div class="photo-info" id="photoInfo" style="display: none; font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.5rem;">
                                    <span id="photoSize"></span>
                                </div>
                            </div>
                        </div>
                        <div class="total-display" id="totalGroup">
                            <span id="totalAmount">0.00 ‚Ç¥</span>
                        </div>
                        <button type="submit" class="save-button" id="saveButton">
                            <i data-lucide="save" class="button-icon"></i>
                            <span class="button-spinner" style="display: none;"></span>
                            <span id="saveButtonText">–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-navigation" id="bottomNavigation">
        <button class="nav-button active" data-tab="home" onclick="switchTab('home')">
            <i data-lucide="home"></i>
            <span>–ì–æ–ª–æ–≤–Ω–∞</span>
        </button>
        <button class="nav-button" data-tab="purchasesList" onclick="switchTab('purchasesList')">
            <i data-lucide="shopping-cart"></i>
            <span>–ó–∞–∫—É–ø–∫–∞</span>
        </button>
        <button class="nav-button" data-tab="unloadingList" onclick="switchTab('unloadingList')">
            <i data-lucide="truck"></i>
            <span>–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>
        </button>
        <button class="nav-button" data-tab="reports" onclick="switchTab('reports')">
            <i data-lucide="pie-chart"></i>
            <span>–ó–≤—ñ—Ç–∏</span>
        </button>
    </nav>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="endDayModal">
        <div class="modal-content glassmorphism">
            <h3>–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–µ–Ω—å?</h3>
            <p>–Ü—Å—Ç–æ—Ä—ñ—é –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å –±—É–¥–µ –æ—á–∏—â–µ–Ω–æ. –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?</p>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelEndDay">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn-destructive" id="confirmEndDay">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–û–î–î–ï–†–ñ–ö–û–ô –û–¢–ü–†–ê–í–ö–ò –§–û–¢–û

        class AppState {
            constructor() {
                this.screen = 'main';
                this.tab = 'home';
                this.isUnloading = false;
                this.isDelivery = false;
                this.editingItemId = null;
            }
            setScreen(screen, options = {}) {
                this.screen = screen;
                if (options.isUnloading !== undefined) this.isUnloading = options.isUnloading;
                if (options.isDelivery !== undefined) this.isDelivery = options.isDelivery;
                if (options.editingItemId !== undefined) this.editingItemId = options.editingItemId;
                else if (screen === 'main') this.editingItemId = null;
                this.updateUI();
            }
            setTab(tab) {
                this.tab = tab;
                this.updateUI();
            }
            updateUI() {
                document.getElementById('mainScreen').style.display = this.screen === 'main' ? 'block' : 'none';
                document.getElementById('purchaseFormScreen').style.display = this.screen === 'purchase-form' ? 'block' : 'none';
                
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                const activeTab = document.getElementById(`${this.tab}Tab`);
                if(activeTab) activeTab.style.display = 'block';

                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === this.tab);
                });
                this.updateHeader();
                document.getElementById('bottomNavigation').style.display = this.screen === 'main' ? 'flex' : 'none';
            }
            updateHeader() {
                const backButton = document.getElementById('backButton');
                const headerTitle = document.getElementById('headerTitle');
                if (this.screen === 'purchase-form') {
                    backButton.style.display = 'flex';
                    if (this.editingItemId) {
                         headerTitle.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å';
                    } else {
                        headerTitle.textContent = this.isUnloading || this.isDelivery ? '–ù–æ–≤–µ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' : '–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è';
                    }
                } else {
                    backButton.style.display = 'none';
                    headerTitle.textContent = '–û–±–ª—ñ–∫ –∑–∞–∫—É–ø—ñ–≤–µ–ª—å';
                }
            }
        }
        const appState = new AppState();
        window.appState = appState;

        const MIN_REQUEST_DELAY_MS = 500;
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const getSecureWebhookUrl = () => {
            const productionUrl = '/api/delivery';
            const localUrl = 'http://localhost:3000/api/delivery';
            let defaultUrl = productionUrl;
            if (typeof window !== 'undefined') {
                const hostname = window.location?.hostname ?? '';
                const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
                if (isLocalhost) defaultUrl = localUrl;
            }
            const overrideUrl = (typeof window !== 'undefined' && window.__SECURE_WEBHOOK_URL__) || '';
            if (overrideUrl && typeof overrideUrl === 'string') {
                try {
                    const parsed = new URL(overrideUrl);
                    if (parsed.protocol === 'https:') {
                        console.log('üîó Webhook URL:', overrideUrl);
                        return overrideUrl;
                    }
                } catch (error) {}
            }
            console.log('üîó Webhook URL:', defaultUrl);
            return defaultUrl;
        };

        const appConfig = {
            N8N_WEBHOOK_URL: getSecureWebhookUrl(),
            units: [
                { value: 'kg', label: '–∫–≥' }, { value: 'piece', label: '—à—Ç' },
                { value: 'pack', label: '—É–ø–∞–∫–æ–≤–∫–∞' }, { value: 'box', label: '—è—â–∏–∫' },
                { value: 'bunch', label: '–ø—É—á–æ–∫' }, { value: 'other', label: '—ñ–Ω—à–µ' }
            ],
            marketLocations: [
                '–ö–∞–ª–∏–Ω—ñ–≤—Å—å–∫–∏–π —Ä–∏–Ω–æ–∫',
                '–ó–µ–ª–µ–Ω–∏–π —Ä–∏–Ω–æ–∫',
                '–ú–µ—Ç—Ä–æ',
                '–°–∫–ª–∞–¥ –æ–≤–æ—á–µ–≤–∏–π',
                '–°–∫–ª–∞–¥ —Å–∏—Ä–æ–≤–∏–Ω–∏ "–¢—Ä–µ–º–±—ñ—Ç–∞"',
                '–Ü–Ω—à–µ'
            ],
            unloadingLocations: ['–ì–µ—Ä–æ—ó–≤ –ú–∞–π–¥–∞–Ω—É', '–ï–Ω—Ç—É–∑—ñ–∞—Å—Ç—ñ–≤', '–ë—É–ª—å–≤–∞—Ä', '–ì—Ä–∞–≤—ñ—Ç–æ–Ω', '–°–∞–¥–æ–≤–∞', '–§–ª–æ—Ä—ñ–¥–∞', '–ï–Ω—Ç—É–∑—ñ–∞—Å—Ç—ñ–≤ 2 –ø–æ–≤–µ—Ä—Ö', '–ü—ñ—Ü–µ—Ä—ñ—è', '–†—É—Å—å–∫–∞', '–°–∫–ª–∞–¥‚Ññ2', '–Ü–Ω—à–µ'],
            products: [
                '–ö–∞—Ä—Ç–æ–ø–ª—è', '–¶–∏–±—É–ª—è', '–¶–∏–±—É–ª—è —Å–∏–Ω—è', '–ö–∞–ø—É—Å—Ç–∞', '–ú–æ—Ä–∫–≤–∞', '–ë—É—Ä—è–∫', '–ì—Ä–∏–±–∏', '–ü–æ–º—ñ–¥–æ—Ä–∏', '–ë–∞–Ω–∞–Ω', '–ß–∞—Å–Ω–∏–∫', '–ü–µ—Ä–µ—Ü—å',
                '–ö–∞–±–∞—á–∫–∏', '–ë–∞–∫–ª–∞–∂–∞–Ω', '–õ–∏–º–æ–Ω', '–ú–∞–π–æ–Ω–µ–∑ —î–≤—Ä–æ 0,520 –≥—Ä–∞–º', '–ú–∞–π–æ–Ω–µ–∑ —â–µ–¥—Ä–æ –ø—Ä–æ–≤–∞–Ω—Å–∞–ª—å 0,550 –≥—Ä–∞–º',
                '–ú–∞–π–æ–Ω–µ–∑ —Å—Ç–æ–ª–∏—á–Ω–∏–π 0,550 –≥—Ä–∞–º', '–ì–∞—Ä–∞–º', '–°—É—Ö–∞—Ä—ñ', '–ö—Ä–µ–∫–µ—Ä –∑ —Ü–∏–±—É–ª–µ—é 0,180 –≥—Ä–∞–º',
                '–ì—ñ—Ä—á–∏—Ü—è –∞–º–µ—Ä–∏–∫–∞–Ω—Å—å–∫–∞ 0,130 –≥—Ä–∞–º', '–°–∏—Ä–∫–∏ —Ñ–µ—Ä–º–∞', '–ó–≥—É—â–µ–Ω–µ –º–æ–ª–æ–∫–æ', '–ú–∞–∫', '–¢–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞', '–ö–∞–≤–∞',
                '–í–µ—Ä—à–∫–∏', '–í–∏—Å—ñ–≤–∫–∏', '–ú–µ–¥', '–î—Ä—ñ–∂–¥–∂—ñ —Å—É—Ö—ñ 0,042 –≥—Ä–∞–º', '–î—Ä—ñ–∂–¥–∂—ñ 0,1 –≥—Ä–∞–º', '–•–º–µ–ª—ñ —Å—É–Ω–µ–ª—ñ', '–û–ª–∏–≤–∫–∏',
                '–ö—É–∫—É—Ä—É–¥–∑–∞', '–ü–µ—á–µ–≤–æ —Ç–æ–ø–ª–µ–Ω–µ –º–æ–ª–æ–∫–æ', '–ü–µ—á–µ–≤–æ –ú–∞—Ä—ñ—è', '–ì–æ—Ä–≥–æ–Ω–∑–æ–ª–∞ —Å–∏—Ä', '–õ–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç',
                '–°—É—Ö–∞ –≥—ñ—Ä—á–∏—Ü—è', '–ü–∞–ø—Ä–∏–∫–∞ –∫–æ–ø—á–µ–Ω–∞', '–õ–∏–º–æ–Ω–Ω–∏–π —Å—ñ–∫'
            ]
        };

        class StorageManager {
            static get(key, defaultValue = []) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) { return defaultValue; }
            }
            static set(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
            static getHistoryItems() { return this.get('purchase_history', []); }
            static setHistoryItems(items) { this.set('purchase_history', items); }
            static addToHistory(item) {
                const items = this.getHistoryItems();
                items.unshift(item);
                this.setHistoryItems(items);
            }
            static updateHistoryItem(id, updatedItem) {
                let items = this.getHistoryItems();
                const itemIndex = items.findIndex(i => i.id === id);
                if (itemIndex > -1) {
                    items[itemIndex] = { ...items[itemIndex], ...updatedItem };
                    this.setHistoryItems(items);
                }
            }
            static deleteHistoryItem(id) {
                let items = this.getHistoryItems();
                items = items.filter(i => i.id !== id);
                this.setHistoryItems(items);
            }
            static clearHistory() { localStorage.removeItem('purchase_history'); }
        }

        class ToastManager {
            static show(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animationName = 'toast-out';
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }
        }

        class ThemeManager {
            static init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme);
                document.getElementById('themeToggle').addEventListener('click', () => {
                    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                });
            }
            static setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                const themeIcon = document.querySelector('.theme-icon');
                if(themeIcon) {
                    themeIcon.setAttribute('data-lucide', theme === 'light' ? 'moon' : 'sun');
                    lucide.createIcons();
                }
            }
        }
        
        window.selectedPhotoBase64 = null;
        let typeChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            ThemeManager.init();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                appState.updateUI();
            }, 500);

            setupEventListeners();
            populateUnitSelect();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed:', err));
            }
        });

        function setupEventListeners() {
            document.getElementById('backButton').addEventListener('click', () => appState.setScreen('main'));
            document.getElementById('purchaseForm').addEventListener('submit', (event) => window.handleFormSubmit(event));
            document.getElementById('photoInput').addEventListener('change', (event) => window.handlePhotoSelect(event));
            document.getElementById('quantity').addEventListener('input', updateTotalAmount);
            document.getElementById('pricePerUnit').addEventListener('input', updateTotalAmount);
            document.getElementById('location').addEventListener('change', handleLocationChange);
            
            document.getElementById('sendPurchasesButton').addEventListener('click', () => sendAllToServer('purchasesList'));
            document.getElementById('sendUnloadingsButton').addEventListener('click', () => sendAllToServer('unloadingList'));

            document.getElementById('cancelEndDay').addEventListener('click', hideEndDayModal);
            document.getElementById('confirmEndDay').addEventListener('click', endWorkDay);
        }

        function switchTab(tab) {
            appState.setTab(tab);
            if (tab === 'purchasesList') updateDisplay('purchasesList');
            if (tab === 'unloadingList') updateDisplay('unloadingList');
            if (tab === 'reports') renderReports();
        }
        
        function startPurchase() {
            appState.setScreen('purchase-form', { isUnloading: false, isDelivery: false });
            setupPurchaseForm();
        }
        function startUnloading() {
            appState.setScreen('purchase-form', { isUnloading: true, isDelivery: false });
            setupPurchaseForm();
        }
        function startDelivery() {
            appState.setScreen('purchase-form', { isUnloading: false, isDelivery: true });
            setupPurchaseForm();
        }
        
        function startEdit(itemId) {
            const items = StorageManager.getHistoryItems();
            const item = items.find(i => i.id === itemId);
            if(!item) return;

            const isUnloading = item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            const isDelivery = item.type === '–î–æ—Å—Ç–∞–≤–∫–∞';
            
            appState.setScreen('purchase-form', { isUnloading, isDelivery, editingItemId: itemId });
            setupPurchaseForm();

            document.getElementById('productName').value = item.productName;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('unit').value = item.unit;
            document.getElementById('pricePerUnit').value = item.pricePerUnit;

            const locationSelect = document.getElementById('location');
            const locationExists = Array.from(locationSelect.options).some(opt => opt.value === item.location);
            if(locationExists) {
                locationSelect.value = item.location;
                 handleLocationChange();
            } else {
                 locationSelect.value = '–Ü–Ω—à–µ';
                 handleLocationChange();
                 document.getElementById('customLocation').value = item.location;
            }
            
            if (item.photoBase64) {
                window.selectedPhotoBase64 = item.photoBase64;
                const previewImage = document.getElementById('previewImage');
                const previewContainer = document.getElementById('photoPreview');
                const fallback = document.getElementById('photoPreviewFallback');
                if (previewImage) {
                    previewImage.onload = () => {
                        if (fallback) fallback.style.display = 'none';
                        previewImage.style.display = '';
                    };
                    previewImage.onerror = () => {
                        if (fallback) fallback.style.display = 'block';
                        previewImage.style.display = 'none';
                    };
                    previewImage.src = item.photoBase64;
                    previewImage.style.opacity = '1';
                }
                if (previewContainer) {
                    previewContainer.style.display = 'block';
                }
                updatePhotoInfoFromBase64(item.photoBase64);
            } else {
                hidePhotoInfo();
            }
            
            updateTotalAmount();
        }

        function setupPurchaseForm() {
            document.getElementById('purchaseForm').reset();
            removePhoto();
            populateDatalist();
            
            const priceGroup = document.getElementById('priceGroup');
            const totalGroup = document.getElementById('totalGroup');
            const locationLabel = document.getElementById('locationLabel');
            const saveButtonText = document.getElementById('saveButtonText');
            const formTitle = document.getElementById('formTitle');
            const formSubtitle = document.getElementById('formSubtitle');
            
            let locations;
            const isEditing = !!appState.editingItemId;
            let currentType = '';
            if (isEditing) {
                const item = StorageManager.getHistoryItems().find(i => i.id === appState.editingItemId);
                if(item) currentType = item.type;
            }

            const isUnloadingState = (!isEditing && appState.isUnloading) || (isEditing && currentType === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
            const isDeliveryState = (!isEditing && appState.isDelivery) || (isEditing && currentType === '–î–æ—Å—Ç–∞–≤–∫–∞');

            if (isDeliveryState) {
                priceGroup.style.display = 'none';
                totalGroup.style.display = 'none';
                locationLabel.textContent = '–ú–∞–≥–∞–∑–∏–Ω (–¥–æ—Å—Ç–∞–≤–∫–∞)';
                locations = appConfig.unloadingLocations;
            } else {
                priceGroup.style.display = 'block';
                totalGroup.style.display = 'block';
                locationLabel.textContent = isUnloadingState ? '–ú–∞–≥–∞–∑–∏–Ω (–≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)' : '–õ–æ–∫–∞—Ü—ñ—è –∑–∞–∫—É–ø–∫–∏';
                locations = isUnloadingState ? appConfig.unloadingLocations : appConfig.marketLocations;
            }

            if (isEditing) {
                formTitle.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å';
                formSubtitle.textContent = '–ó–º—ñ–Ω—ñ—Ç—å –¥–∞–Ω—ñ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å';
                saveButtonText.textContent = '–û–Ω–æ–≤–∏—Ç–∏ –∑–∞–ø–∏—Å';
            } else if (isUnloadingState) {
                formTitle.textContent = '–ù–æ–≤–µ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
                formSubtitle.textContent = '–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è';
                saveButtonText.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ';
            } else if (isDeliveryState) {
                formTitle.textContent = '–ù–æ–≤–∞ –¥–æ—Å—Ç–∞–≤–∫–∞';
                formSubtitle.textContent = '–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è';
                saveButtonText.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ';
            } else {
                formTitle.textContent = '–ù–æ–≤–∞ –∑–∞–∫—É–ø—ñ–≤–ª—è';
                formSubtitle.textContent = '–í–∫–∞–∂—ñ—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ —Ç–æ–≤–∞—Ä';
                saveButtonText.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ';
            }

            setupLocationOptions(locations);
            updateTotalAmount();
            lucide.createIcons();
        }
        
        function populateDatalist() {
            const datalist = document.getElementById('productSuggestions');
            datalist.innerHTML = '';
            appConfig.products.forEach(p => datalist.innerHTML += `<option value="${p}">`);
        }
        
        function populateUnitSelect() {
            const select = document.getElementById('unit');
            select.innerHTML = '';
            appConfig.units.forEach(u => select.innerHTML += `<option value="${u.value}">${u.label}</option>`);
        }

        function setupLocationOptions(locations) {
            const select = document.getElementById('location');
            select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
            locations.forEach(loc => select.innerHTML += `<option value="${loc}">${loc}</option>`);
        }

        function handleLocationChange() {
            const group = document.getElementById('customLocationGroup');
            const customInput = document.getElementById('customLocation');
            const isCustom = document.getElementById('location').value === '–Ü–Ω—à–µ';
            group.style.display = isCustom ? 'block' : 'none';
            customInput.disabled = !isCustom;
            customInput.required = isCustom;
            if (!isCustom) customInput.value = '';
        }

        function updateTotalAmount() {
            if(appState.isDelivery) {
                document.getElementById('totalAmount').textContent = '0.00 ‚Ç¥';
                return;
            }
            const qty = parseFloat(document.getElementById('quantity').value) || 0;
            const price = parseFloat(document.getElementById('pricePerUnit').value) || 0;
            document.getElementById('totalAmount').textContent = (qty * price).toFixed(2) + ' ‚Ç¥';
        }

        function removePhoto() {
            window.selectedPhotoBase64 = null;
            const preview = document.getElementById('photoPreview');
            const previewImage = document.getElementById('previewImage');
            const fallback = document.getElementById('photoPreviewFallback');
            if (preview) preview.style.display = 'none';
            if (previewImage) {
                previewImage.removeAttribute('src');
                previewImage.style.opacity = '1';
                previewImage.style.display = '';
            }
            if (fallback) fallback.style.display = 'none';
            hidePhotoInfo();
            document.getElementById('photoInput').value = '';
        }

        function renderPhotoInfo({ sizeKB, width, height, quality, note } = {}) {
            const infoContainer = document.getElementById('photoInfo');
            const sizeElement = document.getElementById('photoSize');
            if (!infoContainer || !sizeElement) return;

            const parts = [];
            if (typeof sizeKB === 'number' && !Number.isNaN(sizeKB)) {
                parts.push(`–†–æ–∑–º—ñ—Ä: ${sizeKB}KB`);
            }
            if (width && height) {
                parts.push(`${width}√ó${height}`);
            }
            if (typeof quality === 'number' && !Number.isNaN(quality)) {
                parts.push(`–Ø–∫—ñ—Å—Ç—å: ${quality}%`);
            }
            if (note) {
                parts.push(note);
            }

            if (parts.length === 0) {
                infoContainer.style.display = 'none';
                sizeElement.textContent = '';
                sizeElement.classList.remove('size-warning');
                return;
            }

            const limitKB = (typeof IMAGE_CONFIG !== 'undefined' && IMAGE_CONFIG.maxSizeKB) || 0;
            const shouldWarn = limitKB && typeof sizeKB === 'number' && sizeKB > limitKB;

            infoContainer.style.display = 'flex';
            sizeElement.textContent = parts.join(' ‚Ä¢ ');
            sizeElement.classList.toggle('size-warning', Boolean(shouldWarn));
        }

        function updatePhotoInfoFromBase64(base64, extra = {}) {
            if (!base64) {
                hidePhotoInfo();
                return;
            }
            const commaIndex = base64.indexOf(',');
            const baseLength = commaIndex >= 0 ? base64.length - commaIndex - 1 : base64.length;
            const sizeKB = Math.round((baseLength * 3) / 4 / 1024);
            renderPhotoInfo({ sizeKB, ...extra });
        }

        function hidePhotoInfo() {
            const infoContainer = document.getElementById('photoInfo');
            const sizeElement = document.getElementById('photoSize');
            if (!infoContainer || !sizeElement) return;
            infoContainer.style.display = 'none';
            sizeElement.textContent = '';
            sizeElement.classList.remove('size-warning');
        }

        function dataURLToBlob(dataUrl) {
            if (typeof dataUrl !== 'string') return null;
            const parts = dataUrl.split(',');
            if (parts.length < 2) return null;

            const meta = parts[0];
            const base64Data = parts[1];
            const mimeMatch = meta.match(/data:(.*?);base64/);
            const mimeType = mimeMatch ? mimeMatch[1] : 'application/octet-stream';

            try {
                const byteString = atob(base64Data);
                const arrayBuffer = new Uint8Array(byteString.length);
                for (let i = 0; i < byteString.length; i++) {
                    arrayBuffer[i] = byteString.charCodeAt(i);
                }
                return new Blob([arrayBuffer], { type: mimeType });
            } catch (error) {
                console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–æ—Ç–æ —É Blob:', error);
                return null;
            }
        }

        function buildPhotoFilename(item, mimeType) {
            const safeName = (item.productName || 'photo')
                .toLowerCase()
                .replace(/[^a-z0-9]+/gi, '-')
                .replace(/^-+|-+$/g, '') || 'photo';
            const timestamp = item.timestamp ? new Date(item.timestamp).toISOString().replace(/[:.]/g, '-') : Date.now();
            const extension = mimeType === 'image/png' ? 'png' : mimeType === 'image/webp' ? 'webp' : 'jpg';
            return `${safeName}-${timestamp}.${extension}`;
        }

        async function transmitItemToWebhook(item, index, total, itemsById) {
            console.log(`üì¶ [${index + 1}/${total}] –û—Ç–ø—Ä–∞–≤–∫–∞: ${item.productName}`);

            const eventDate = new Date(item.timestamp);
            const isoDate = eventDate.toISOString();
            const [datePart, timePartWithMs] = isoDate.split('T');
            const timePart = timePartWithMs ? timePartWithMs.split('.')[0] : '';

            const payload = {
                id: item.id,
                type: item.type,
                timestamp: item.timestamp,
                date: datePart,
                time: timePart,
                productName: item.productName,
                quantity: item.quantity,
                unit: item.unit,
                pricePerUnit: item.pricePerUnit,
                totalAmount: item.totalAmount,
                location: item.location
            };

            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));

            const storedItem = itemsById.get(item.id) || item;
            const photoBase64 = storedItem.photoBase64;
            if (photoBase64) {
                const blob = dataURLToBlob(photoBase64);
                if (blob) {
                    const filename = buildPhotoFilename(storedItem, blob.type);
                    formData.append('file', blob, filename);
                    console.log(`üì∏ –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ —è–∫ —Ñ–∞–π–ª '${filename}' (${(blob.size / 1024).toFixed(2)} KB)`);
                }
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            try {
                const apiUrl = '/api/delivery';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal,
                    mode: 'cors'
                });

                const responseText = await response.text();
                if (!response.ok) {
                    console.error(`‚ùå HTTP ${response.status}:`, responseText);
                    throw new Error(`HTTP ${response.status}: ${responseText.substring(0, 100)}`);
                }

                console.log(`‚úÖ –£—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${item.productName}`);
                return item.id;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function sendAllToServer(listType) {
            const buttonId = listType === 'purchasesList' ? 'sendPurchasesButton' : 'sendUnloadingsButton';
            const button = document.getElementById(buttonId);
            const buttonIcon = button.querySelector('.button-icon');
            const buttonSpinner = button.querySelector('.button-spinner');

            button.disabled = true;
            buttonIcon.style.display = 'none';
            buttonSpinner.style.display = 'inline-block';

            const allItems = StorageManager.getHistoryItems();
            const itemsById = new Map(allItems.map(item => [item.id, item]));
            const itemsToSend = allItems.filter(item => {
                if (listType === 'purchasesList') return item.type === '–ó–∞–∫—É–ø–∫–∞';
                return item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' || item.type === '–î–æ—Å—Ç–∞–≤–∫–∞';
            });

            if (itemsToSend.length === 0) {
                ToastManager.show('–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏', 'info');
                button.disabled = false;
                buttonIcon.style.display = 'inline-block';
                buttonSpinner.style.display = 'none';
                return;
            }

            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${itemsToSend.length} –∑–∞–ø–∏—Å–µ–π...`);

            const successfulIds = new Set();

            for (let index = 0; index < itemsToSend.length; index++) {
                const item = itemsToSend[index];
                try {
                    const resultId = await transmitItemToWebhook(item, index, itemsToSend.length, itemsById);
                    if (resultId) {
                        successfulIds.add(resultId);
                    }
                } catch (error) {
                    const message = error?.message || error;
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ [${item.productName}]:`, message);
                }

                if (index < itemsToSend.length - 1) {
                    console.log(`‚è≥ –ü–∞—É–∑–∞ ${MIN_REQUEST_DELAY_MS}–º—Å –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é –∑–∞—è–≤–∫–æ—é`);
                    await delay(MIN_REQUEST_DELAY_MS);
                }
            }

            const failedCount = itemsToSend.length - successfulIds.size;

            console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${successfulIds.size} —É—Å–ø—ñ—à–Ω–æ, ${failedCount} –ø–æ–º–∏–ª–æ–∫`);

            // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
            const remainingItems = allItems.filter(item => !successfulIds.has(item.id));
            StorageManager.setHistoryItems(remainingItems);
            
            updateDisplay(listType);

            if (failedCount > 0) {
                ToastManager.show(`–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${successfulIds.size}. –ü–æ–º–∏–ª–∫–∞: ${failedCount}`, 'error');
            } else {
                ToastManager.show(`–í—Å—ñ ${successfulIds.size} –∑–∞–ø–∏—Å–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ`, 'success');
            }
            
            button.disabled = false;
            buttonIcon.style.display = 'inline-block';
            buttonSpinner.style.display = 'none';
        }

        function updateDisplay(listType) {
            const allItems = StorageManager.getHistoryItems();
            let itemsToShow;
            let container, summary, empty;

            if (listType === 'purchasesList') {
                itemsToShow = allItems.filter(item => item.type === '–ó–∞–∫—É–ø–∫–∞');
                container = document.getElementById('purchasesListItems');
                summary = document.getElementById('purchasesListSummary');
                empty = document.getElementById('purchasesListEmpty');
            } else {
                itemsToShow = allItems.filter(item => item.type === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' || item.type === '–î–æ—Å—Ç–∞–≤–∫–∞');
                container = document.getElementById('unloadingListItems');
                summary = document.getElementById('unloadingListSummary');
                empty = document.getElementById('unloadingListEmpty');
            }

            container.innerHTML = '';

            if(itemsToShow.length > 0) {
                empty.style.display = 'none';
                
                itemsToShow.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item glassmorphism';
                    const unitLabel = appConfig.units.find(u => u.value === item.unit)?.label || item.unit;
                    const photoPreviewHTML = item.photoBase64 
                        ? `<img src="${item.photoBase64}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; margin-right: 12px;">` 
                        : '<div style="width: 40px; height: 40px; margin-right: 12px;"></div>';

                    itemEl.innerHTML = `
                        <div class="cart-item-header">
                            <div style="display: flex; align-items: center; flex-grow: 1;">
                                ${photoPreviewHTML}
                                <div>
                                    <div class="cart-item-name">${item.productName}</div>
                                    <div class="cart-item-category">${item.type}</div>
                                </div>
                            </div>
                            <div class="cart-item-actions">
                                <button onclick="startEdit('${item.id}')"><i data-lucide="edit-2"></i></button>
                                <button class="delete" onclick="deleteItem('${item.id}')"><i data-lucide="trash-2"></i></button>
                            </div>
                        </div>
                        <div class="cart-item-details">
                            <div><span class="cart-item-detail-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</span> ${item.quantity} ${unitLabel}</div>
                            <div><span class="cart-item-detail-label">–õ–æ–∫–∞—Ü—ñ—è:</span> ${item.location}</div>
                            <div class="cart-item-total"><span class="cart-item-detail-label">–°—É–º–∞:</span> ${item.totalAmount.toFixed(2)} ‚Ç¥</div>
                        </div>
                    `;
                    container.appendChild(itemEl);
                });
                summary.textContent = `${itemsToShow.length} –∑–∞–ø–∏—Å(—ñ–≤)`;
            } else {
                empty.style.display = 'block';
                summary.textContent = '–©–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤';
            }
            lucide.createIcons();
        }

        function deleteItem(id) {
            const itemToDelete = StorageManager.getHistoryItems().find(item => item.id === id);
            StorageManager.deleteHistoryItem(id);
            if (itemToDelete.type === '–ó–∞–∫—É–ø–∫–∞') {
                updateDisplay('purchasesList');
            } else {
                updateDisplay('unloadingList');
            }
            ToastManager.show('–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
        }

        function renderReports() {
            const items = StorageManager.getHistoryItems();
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            const totalSpent = items.reduce((sum, item) => sum + item.totalAmount, 0);
            const totalItems = items.length;
            
            const stats = [
                { label: '–í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—á–µ–Ω–æ', value: `${totalSpent.toFixed(2)} ‚Ç¥` },
                { label: '–í—Å—å–æ–≥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π', value: totalItems },
            ];

            stats.forEach(stat => {
                statsGrid.innerHTML += `
                    <div class="stat-card glassmorphism">
                        <div class="stat-card-value">${stat.value}</div>
                        <div class="stat-card-label">${stat.label}</div>
                    </div>
                `;
            });

            const ctx = document.getElementById('typeChart').getContext('2d');
            const dataByType = items.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + item.totalAmount;
                return acc;
            }, {});

            if(typeChartInstance) {
                typeChartInstance.destroy();
            }

            typeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataByType),
                    datasets: [{
                        label: '–í–∏—Ç—Ä–∞—Ç–∏ –∑–∞ —Ç–∏–ø–æ–º',
                        data: Object.values(dataByType),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b'],
                        borderColor: 'var(--card)',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'var(--foreground)' } },
                    }
                }
            });
        }

        function showEndDayModal() {
            document.getElementById('endDayModal').classList.add('visible');
        }
        function hideEndDayModal() {
            document.getElementById('endDayModal').classList.remove('visible');
        }
        function endWorkDay() {
            StorageManager.clearHistory();
            updateDisplay('purchasesList');
            updateDisplay('unloadingList');
            hideEndDayModal();
            ToastManager.show('–†–æ–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ.', 'success');
        }

        // ============================================
        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ü–†–û–ë–õ–ï–ú–ò –ó –§–û–¢–û –ù–ê iOS
        // ============================================
        const IMAGE_CONFIG = {
            maxWidth: 1024,
            maxHeight: 1024,
            quality: 0.85,
            maxSizeKB: 500
        };
        window.IMAGE_CONFIG = IMAGE_CONFIG;

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onerror = () => reject(new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª'));

                reader.onload = (e) => {
                    const img = new Image();

                    img.onerror = () => reject(new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'));

                    img.onload = () => {
                        try {
                            let width = img.width;
                            let height = img.height;

                            if (width > IMAGE_CONFIG.maxWidth || height > IMAGE_CONFIG.maxHeight) {
                                const ratio = Math.min(
                                    IMAGE_CONFIG.maxWidth / width,
                                    IMAGE_CONFIG.maxHeight / height
                                );
                                width = Math.round(width * ratio);
                                height = Math.round(height * ratio);
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, width, height);

                            let quality = IMAGE_CONFIG.quality;
                            let compressed = canvas.toDataURL('image/jpeg', quality);

                            while (compressed.length > IMAGE_CONFIG.maxSizeKB * 1024 * 1.37 && quality > 0.5) {
                                quality -= 0.05;
                                compressed = canvas.toDataURL('image/jpeg', quality);
                            }

                            const finalSizeKB = Math.round(compressed.length / 1024 / 1.37);
                            const originalSizeKB = Math.round(file.size / 1024);

                            console.log(`üì∏ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∏—Å–Ω—É—Ç–æ: ${originalSizeKB}KB ‚Üí ${finalSizeKB}KB`);

                            resolve({
                                dataUrl: compressed,
                                sizeKB: finalSizeKB,
                                width,
                                height,
                                quality: Math.round(quality * 100),
                                originalSizeKB
                            });

                        } catch (error) {
                            reject(new Error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è: ' + error.message));
                        }
                    };

                    img.src = e.target.result;
                };

                reader.readAsDataURL(file);
            });
        }

        window.handlePhotoSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const previewContainer = document.getElementById('photoPreview');
            const previewImage = document.getElementById('previewImage');
            const fallback = document.getElementById('photoPreviewFallback');
            const originalSizeKB = Math.round(file.size / 1024);

            if (previewContainer) {
                previewContainer.style.display = 'block';
            }
            if (fallback) {
                fallback.style.display = 'none';
            }
            if (previewImage) {
                previewImage.onload = () => {
                    if (fallback) fallback.style.display = 'none';
                    previewImage.style.display = '';
                };
                previewImage.onerror = () => {
                    if (fallback) fallback.style.display = 'block';
                    previewImage.style.display = 'none';
                };
                previewImage.style.opacity = '0.5';
                previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQ+Li4uPC90ZXh0Pjwvc3ZnPg==';
            }

            try {
                const compressed = await compressImage(file);

                window.selectedPhotoBase64 = compressed.dataUrl;

                if (previewImage) {
                    previewImage.src = compressed.dataUrl;
                    previewImage.style.opacity = '1';
                }

                renderPhotoInfo({
                    sizeKB: compressed.sizeKB,
                    width: compressed.width,
                    height: compressed.height,
                    quality: compressed.quality,
                    note: compressed.originalSizeKB ? `–ë—É–ª–æ: ${compressed.originalSizeKB}KB` : undefined
                });

                if (compressed.quality < 80) {
                    ToastManager.show(
                        `–§–æ—Ç–æ —Å—Ç–∏—Å–Ω—É—Ç–æ –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è (${compressed.sizeKB}KB)`,
                        'info'
                    );
                }

                if (compressed.sizeKB > IMAGE_CONFIG.maxSizeKB) {
                    ToastManager.show(
                        `–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: —Ñ–æ—Ç–æ –≤—Å–µ —â–µ –º–∞—î —Ä–æ–∑–º—ñ—Ä ${compressed.sizeKB}KB`,
                        'warning'
                    );
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ:', error);

                try {
                    const fallbackDataUrl = await new Promise((resolve, reject) => {
                        const fallbackReader = new FileReader();
                        fallbackReader.onerror = () => reject(new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª (fallback)'));
                        fallbackReader.onload = (ev) => resolve(ev.target.result);
                        fallbackReader.readAsDataURL(file);
                    });

                    window.selectedPhotoBase64 = fallbackDataUrl;

                    if (previewImage) {
                        previewImage.src = fallbackDataUrl;
                        previewImage.style.opacity = '1';
                        previewImage.style.display = '';
                    }
                    if (previewContainer) {
                        previewContainer.style.display = 'block';
                    }

                    renderPhotoInfo({
                        sizeKB: originalSizeKB,
                        note: '–ë–µ–∑ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è'
                    });

                    ToastManager.show(
                        '–§–æ—Ç–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –±–µ–∑ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è. –ú–æ–∂–µ –∑–∞–π–º–∞—Ç–∏ –±–∞–≥–∞—Ç–æ –º—ñ—Å—Ü—è.',
                        'warning'
                    );

                } catch (fallbackError) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ:', fallbackError);

                    window.selectedPhotoBase64 = null;
                    if (previewContainer) {
                        previewContainer.style.display = 'none';
                    }
                    if (previewImage) {
                        previewImage.removeAttribute('src');
                        previewImage.style.opacity = '1';
                        previewImage.style.display = '';
                    }
                    if (fallback) {
                        fallback.style.display = 'none';
                    }
                    hidePhotoInfo();
                    event.target.value = '';

                    ToastManager.show(
                        '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.',
                        'error'
                    );
                }
            }
        };

        const OriginalStorageManager = window.StorageManager;

        window.StorageManager = class extends OriginalStorageManager {
            static setHistoryItems(items) {
                try {
                    localStorage.setItem('purchase_history', JSON.stringify(items));
                    return true;

                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage:', error);

                    if (error.name === 'QuotaExceededError' || error.code === 22) {
                        console.warn('‚ö†Ô∏è localStorage –∑–∞–ø–æ–≤–Ω–µ–Ω–æ. –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏...');

                        try {
                            const reducedItems = items.slice(0, 50);
                            localStorage.setItem('purchase_history', JSON.stringify(reducedItems));

                            ToastManager.show(
                                '–Ü—Å—Ç–æ—Ä—ñ—é —Å–∫–æ—Ä–æ—á–µ–Ω–æ —á–µ—Ä–µ–∑ –ª—ñ–º—ñ—Ç –ø–∞–º\'—è—Ç—ñ. –°—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–∞–ª–µ–Ω–æ.',
                                'warning'
                            );

                            return true;

                        } catch (retryError) {
                            console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è:', retryError);

                            ToastManager.show(
                                '–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞—î—Ç—å—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ —ñ—Å–Ω—É—é—á—ñ –∑–∞–ø–∏—Å–∏ –≤ n8n.',
                                'error'
                            );

                            return false;
                        }
                    }

                    ToastManager.show(
                        '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + error.message,
                        'error'
                    );

                    return false;
                }
            }

            static addToHistory(item) {
                const items = this.getHistoryItems();
                items.unshift(item);

                const success = this.setHistoryItems(items);

                if (!success) {
                    console.error('‚ùå –ó–∞–ø–∏—Å –ù–ï –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ:', item.id);
                    throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ');
                }

                console.log('‚úÖ –ó–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ:', item.id);
                return true;
            }

            static updateHistoryItem(id, updatedItem) {
                let items = this.getHistoryItems();
                const itemIndex = items.findIndex(i => i.id === id);

                if (itemIndex > -1) {
                    items[itemIndex] = { ...items[itemIndex], ...updatedItem };
                    const success = this.setHistoryItems(items);

                    if (!success) {
                        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–∞–ø–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ');
                    }

                    return true;
                }

                return false;
            }
        };

        window.handleFormSubmit = async function(event) {
            event.preventDefault();

            const isEditing = !!window.appState.editingItemId;
            let type = '–ó–∞–∫—É–ø–∫–∞';

            if (!isEditing) {
                if (window.appState.isUnloading) type = '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
                if (window.appState.isDelivery) type = '–î–æ—Å—Ç–∞–≤–∫–∞';
            } else {
                const item = StorageManager.getHistoryItems().find(i => i.id === window.appState.editingItemId);
                if (item) type = item.type;
            }

            const productName = document.getElementById('productName').value.trim();
            const quantity = parseFloat(document.getElementById('quantity').value);
            let location = document.getElementById('location').value;

            if (location === '–Ü–Ω—à–µ') {
                location = document.getElementById('customLocation').value.trim();
            }

            const priceInputValue = document.getElementById('pricePerUnit').value.trim();
            const hasPriceInput = priceInputValue !== '';
            const rawPricePerUnit = hasPriceInput ? parseFloat(priceInputValue) : NaN;
            const hasValidPrice = hasPriceInput && !isNaN(rawPricePerUnit) && rawPricePerUnit >= 0;
            const requiresPrice = type === '–ó–∞–∫—É–ø–∫–∞';

            if ((requiresPrice && !hasValidPrice) || (!requiresPrice && hasPriceInput && !hasValidPrice)) {
                ToastManager.show('–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É –∑–∞ –æ–¥–∏–Ω–∏—Ü—é', 'error');
                return;
            }

            const pricePerUnit = hasValidPrice ? rawPricePerUnit : 0;
            const validQuantity = Number.isFinite(quantity) ? quantity : 0;
            const computedTotal = validQuantity * pricePerUnit;
            const totalAmount = Number.isFinite(computedTotal) ? Number(computedTotal.toFixed(2)) : 0;

            const itemData = {
                id: isEditing ? window.appState.editingItemId : crypto.randomUUID(),
                productName,
                quantity,
                unit: document.getElementById('unit').value,
                pricePerUnit,
                totalAmount,
                location,
                timestamp: new Date().toISOString(),
                type,
                photoBase64: window.selectedPhotoBase64,
            };

            try {
                if (isEditing) {
                    StorageManager.updateHistoryItem(window.appState.editingItemId, itemData);
                    ToastManager.show(`'${productName}' –æ–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ`, 'success');
                } else {
                    StorageManager.addToHistory(itemData);
                    ToastManager.show(`'${productName}' –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ`, 'success');
                }

                window.appState.setScreen('main');

                if (itemData.type === '–ó–∞–∫—É–ø–∫–∞') {
                    window.appState.setTab('purchasesList');
                } else {
                    window.appState.setTab('unloadingList');
                }

                updateDisplay(window.appState.tab);

            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error);

                ToastManager.show(
                    `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å${window.selectedPhotoBase64 ? ' –∑ —Ñ–æ—Ç–æ' : ''}. ` +
                    '–°–ø—Ä–æ–±—É–π—Ç–µ: 1) –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∑–∞–ø–∏—Å–∏ 2) –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ 3) –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é',
                    'error'
                );
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const testKey = '__storage_test__';
                let i = 0;
                let available = 0;

                try {
                    for (i = 0; i < 10000; i++) {
                        localStorage.setItem(testKey + i, '1234567890'.repeat(100));
                    }
                    available = Math.round(i * 1000 / 1024);
                } catch (e) {
                    available = Math.round(i * 1000 / 1024);
                } finally {
                    for (let j = 0; j < i; j++) {
                        localStorage.removeItem(testKey + j);
                    }
                }

                console.log(`üìä –î–æ—Å—Ç—É–ø–Ω–æ localStorage: ~${available}KB`);

                let currentSize = 0;
                for (let key in localStorage) {
                    if (Object.prototype.hasOwnProperty.call(localStorage, key)) {
                        currentSize += localStorage[key].length + key.length;
                    }
                }

                currentSize = Math.round(currentSize / 1024);
                console.log(`üíæ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ localStorage: ~${currentSize}KB`);

                if (available > 0 && currentSize > available * 0.8) {
                    console.warn('‚ö†Ô∏è localStorage –º–∞–π–∂–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ! –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ.');
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ localStorage:', error);
            }
        });

        console.log('‚úÖ iOS Photo Fix –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');

        window.switchTab = switchTab;
        window.startPurchase = startPurchase;
        window.startUnloading = startUnloading;
        window.startDelivery = startDelivery;
        window.startEdit = startEdit;
        window.deleteItem = deleteItem;
        window.showEndDayModal = showEndDayModal;
        window.removePhoto = removePhoto;
    </script>
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-actions button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-secondary {
            background: var(--muted);
            color: var(--muted-foreground);
        }
        .btn-destructive {
            background: var(--destructive);
            color: var(--destructive-foreground);
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
        }
        .stat-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-card-label {
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
        }
        .reports-page {
            padding: 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</body>
</html>
